version: '2'

services:
  sonarqube:
      image: localhost:5000/timw/sonarqube
      ports:
          - ${http_port}:9000
      links:
          - postgres
      environment:
          http_proxy: ${http_proxy}
          https_proxy: ${https_proxy}
          SONARQUBE_JDBC_USERNAME: ${postgres_user}
          SONARQUBE_JDBC_PASSWORD: ${postgres_password}
          SONARQUBE_JDBC_URL: jdbc:postgresql://postgres/sonar

  postgres-data:
      image: busybox
      network_mode: "none"
      labels:
        io.rancher.container.start_once: true
      volumes:
      - sonarqube-data:${postgres_data}

  postgres:
      image: postgres:latest
      ports:
          - ${postgress_port}:5432
      environment:
          PGDATA: ${postgres_data}
          POSTGRES_DB: ${postgres_db}
          POSTGRES_USER: ${postgres_user}
          POSTGRES_PASSWORD: ${postgres_password}
      tty: true
      stdin_open: true
      labels:
          io.rancher.sidekicks: postgres-data
      volumes_from:
          - postgres-data

volumes:
  sonarqube-data:
    driver: rancher-nfs
    external: true
